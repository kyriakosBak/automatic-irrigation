<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Irrigation Control</title>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary-color: #64748b;
      --success-color: #059669;
      --warning-color: #d97706;
      --danger-color: #dc2626;
      --background: #f8fafc;
      --card-background: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body { 
      font-family: Arial, sans-serif;
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 1rem;
      background: var(--background);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    h1 { 
      font-size: 1.75rem; 
      font-weight: 700;
      margin: 0 0 1.5rem 0; 
      text-align: center;
      color: var(--text-primary);
    }
    
    h2 { 
      font-size: 1rem; 
      font-weight: 600;
      margin: 0 0 0.75rem 0; 
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h2::before {
      content: '';
      width: 4px;
      height: 1rem;
      background: var(--primary-color);
      border-radius: 2px;
    }

    h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 1.5rem 0 0.75rem 0;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.025em;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
    }

    h3:first-of-type {
      margin-top: 0;
    }
    
    .card { 
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    
    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem;
      background: var(--background);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .status-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .status-value {
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .inline-form {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .form-group label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    input[type=number], input[type=text] { 
      width: 120px;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.875rem;
      transition: border-color 0.15s ease;
    }
    
    input[type=number]:focus, input[type=text]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
    }
    
    button { 
      padding: 0.5rem 1rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: background-color 0.15s ease;
      min-height: 36px;
    }
    
    button:hover { 
      background: var(--primary-hover);
    }

    button.secondary {
      background: var(--secondary-color);
    }

    button.secondary:hover {
      background: #475569;
    }

    button.danger {
      background: var(--danger-color);
    }

    button.danger:hover {
      background: #b91c1c;
    }

    button.success {
      background: var(--success-color);
    }

    button.success:hover {
      background: #047857;
    }
    
    .error { 
      color: var(--danger-color);
      font-weight: 600;
      margin: 0.5rem 0;
      padding: 0.75rem;
      background: rgb(220 38 38 / 0.1);
      border-radius: 6px;
      border-left: 4px solid var(--danger-color);
    }
    
    table { 
      width: 100%;
      border-collapse: collapse;
      margin: 0.75rem 0;
      font-size: 0.8rem;
      background: var(--card-background);
      border-radius: 6px;
      overflow: hidden;
    }
    
    th, td { 
      padding: 0.5rem 0.25rem;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }
    
    th { 
      background: var(--background);
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    tbody tr:hover {
      background: var(--background);
    }
    
    input.dosing-input { 
      width: 50px;
      padding: 0.25rem;
      text-align: center;
      font-size: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .control-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .compact-table {
      font-size: 0.75rem;
    }

    .compact-table th,
    .compact-table td {
      padding: 0.375rem 0.25rem;
    }

    .pump-controls {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 0.5rem;
      align-items: center;
    }

    .pump-name {
      font-weight: 500;
      text-align: left;
      padding-left: 0.5rem;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: var(--background);
      border-radius: 6px;
    }

    .cal-label {
      font-weight: 500;
      font-size: 0.875rem;
    }

    .cal-input-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .cal-input-group input {
      width: 80px;
    }

    .cal-unit {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Logs section styles */
    .logs-controls {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .refresh-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .refresh-controls select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.875rem;
      background: var(--card-background);
    }

    .log-filter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .log-filter input {
      width: 150px;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .log-options {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .log-option {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.875rem;
    }

    .log-option input[type="checkbox"] {
      margin: 0;
    }

    .log-container {
      background: #1e1e1e;
      color: #f0f0f0;
      border-radius: 6px;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.4;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .log-entry {
      margin-bottom: 0.25rem;
      word-wrap: break-word;
    }

    .log-entry.filtered {
      display: none;
    }

    .log-entry.highlight {
      background-color: rgba(255, 255, 0, 0.2);
    }

    .log-timestamp {
      color: #888;
    }

    .log-timestamp.hidden {
      display: none;
    }

    .log-message {
      color: #f0f0f0;
    }

    .logs-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
    }

    .status-dot.disconnected {
      background: var(--danger-color);
    }

    .status-dot.loading {
      background: var(--warning-color);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .log-empty {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem;
      font-style: italic;
    }

    .scroll-indicator {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      background: var(--primary-color);
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
    }

    .scroll-indicator.visible {
      opacity: 0.8;
    }

    .scroll-indicator:hover {
      opacity: 1;
    }
    
    /* Mobile styles */
    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
        font-size: 13px;
      }

      .main-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }
      
      .card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .status-grid {
        grid-template-columns: 1fr !important;
        gap: 0.5rem;
      }

      .status-item {
        padding: 0.5rem;
      }
      
      .inline-form {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      .form-group {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      
      .control-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group button,
      .button-grid button {
        width: 100%;
      }

      .button-grid {
        grid-template-columns: 1fr;
      }
      
      th, td {
        padding: 0.375rem 0.125rem;
        font-size: 0.7rem;
      }
      
      input.dosing-input {
        width: 45px;
        font-size: 0.7rem;
      }
      
      input[type=number], input[type=text] {
        width: 80px;
      }

      .pump-controls {
        grid-template-columns: 1fr;
        gap: 0.25rem;
        text-align: center;
      }

      .pump-name {
        text-align: center;
        padding: 0.5rem;
        background: var(--background);
        border-radius: 4px;
        font-weight: 600;
      }

      .cal-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <h1>Irrigation Control System</h1>
  
  <div id="error" class="error"></div>
  
  <div class="card full-width">
    <h2>System Status</h2>
    <div class="status-grid">
      <div class="status-item">
        <div class="status-label">Tank Full</div>
        <div class="status-value" id="tankFull">?</div>
      </div>
      <div class="status-item">
        <div class="status-label">Filling</div>
        <div class="status-value" id="filling">?</div>
      </div>
      <div class="status-item">
        <div class="status-label">Humidifier Pump</div>
        <div class="status-value" id="humidifierPump">?</div>
      </div>
      <div class="status-item">
        <div class="status-label">Watering Pump</div>
        <div class="status-value" id="wateringPump">?</div>
      </div>
      <div class="status-item">
        <div class="status-label">Watering Today</div>
        <div class="status-value" id="wateringToday">?</div>
      </div>
      <div class="status-item">
        <div class="status-label">NTP Synced</div>
        <div class="status-value" id="ntp">?</div>
      </div>
      <div class="status-item">
        <div class="status-label">Current Time</div>
        <div class="status-value" id="time">?</div>
      </div>
    </div>
  </div>

  <div class="main-grid">
    <div class="card">
      <h2>System Controls</h2>
      
      <h3>Tank Controls</h3>
      <div class="button-grid">
        <button id="fillMainBtn" class="success">Fill Main</button>
        <button id="stopMainBtn" class="danger">Stop Fill</button>
      </div>
      <form id="humidifierPumpForm" class="inline-form">
        <div class="form-group">
          <label>Duration (ms)</label>
          <input type="number" id="humidifierMs" value="5000">
        </div>
        <button type="submit">Run Humidifier</button>
        <button type="button" id="stopHumidifierBtn" class="secondary">Stop</button>
      </form>

      <form id="wateringPumpForm" class="inline-form">
        <div class="form-group">
          <label>Duration (ms)</label>
          <input type="number" id="wateringMs" value="300000">
        </div>
        <button type="submit">Run Watering Pump</button>
        <button type="button" id="stopWateringBtn" class="secondary">Stop</button>
      </form>

      <h3>System Settings</h3>
      <form id="fertSpeedForm" class="inline-form">
        <div class="form-group">
          <label>Fertilizer Motor Speed</label>
          <input type="number" id="fertSpeed" min="1" max="255" value="50">
        </div>
        <div class="form-group">
          <label>Default Watering Duration (ms)</label>
          <input type="number" id="wateringDuration" min="1000" max="1800000" value="300000">
        </div>
        <button type="submit">Save Settings</button>
      </form>

      <h3>Schedule & Watering</h3>
      <form id="scheduleForm" class="inline-form">
        <div class="form-group">
          <label>Hour</label>
          <input type="number" id="hour" min="0" max="23">
        </div>
        <div class="form-group">
          <label>Minute</label>
          <input type="number" id="minute" min="0" max="59">
        </div>
        <button type="submit">Save</button>
      </form>
      <div class="button-grid">
        <button id="startWateringBtn" class="success">Start Watering</button>
      </div>
    </div>

    <div class="card">
      <h2>Pump Calibration</h2>
      <form id="calForm">
        <div id="calInputs"></div>
        <button type="submit">Save Calibration</button>
      </form>
    </div>
  </div>

  <div class="card full-width">
    <h2>Weekly Dosing Schedule</h2>
    <form id="weeklyDosingForm">
      <table id="weeklyDosingTable" class="compact-table">
        <thead>
          <tr>
            <th>Day</th>
            <th>Water</th>
            <th>Bio-Grow<br>(ml)</th>
            <th>Bio-Bloom<br>(ml)</th>
            <th>Top-Max<br>(ml)</th>
            <th>CalMag<br>(ml)</th>
            <th>PhDown<br>(ml)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="button-grid">
        <button type="submit">Save Weekly Schedule</button>
      </div>
    </form>
  </div>

  <div class="card full-width">
    <h2>Debug - Manual Pump Control</h2>
    <div class="pump-controls">
      <div class="pump-name">Bio-Grow</div>
      <button type="button" id="debugBioGrowOn" class="success">On</button>
      <button type="button" id="debugBioGrowOff" class="danger">Off</button>
      
      <div class="pump-name">Bio-Bloom</div>
      <button type="button" id="debugBioBloomOn" class="success">On</button>
      <button type="button" id="debugBioBloomOff" class="danger">Off</button>
      
      <div class="pump-name">Top-Max</div>
      <button type="button" id="debugTopMaxOn" class="success">On</button>
      <button type="button" id="debugTopMaxOff" class="danger">Off</button>
      
      <div class="pump-name">CalMag</div>
      <button type="button" id="debugCalMagOn" class="success">On</button>
      <button type="button" id="debugCalMagOff" class="danger">Off</button>
      
      <div class="pump-name">PhDown</div>
      <button type="button" id="debugPhDownOn" class="success">On</button>
      <button type="button" id="debugPhDownOff" class="danger">Off</button>
      
      <div class="pump-name">Main Tank</div>
      <button type="button" id="debugMainTankOn" class="success">On</button>
      <button type="button" id="debugMainTankOff" class="danger">Off</button>
      
      <div class="pump-name">Humidifier Pump</div>
      <button type="button" id="debugHumidifierPumpOn" class="success">On</button>
      <button type="button" id="debugHumidifierPumpOff" class="danger">Off</button>
    </div>
    <div class="button-grid" style="margin-top: 1rem;">
      <button type="button" id="stopAllPumps" class="danger">Stop All Pumps</button>
    </div>
  </div>

  <div class="card full-width">
    <h2>System Logs</h2>
    <div class="logs-info">
      <div>
        <span id="logCount">0</span> entries
        <span id="lastUpdate"></span>
      </div>
      <div class="connection-status">
        <span class="status-dot" id="connectionStatus"></span>
        <span id="connectionText">Connected</span>
      </div>
    </div>
    <div class="logs-controls">
      <div class="refresh-controls">
        <label>Auto-refresh:</label>
        <select id="refreshInterval">
          <option value="0">Off</option>
          <option value="1">1 second</option>
          <option value="5">5 seconds</option>
          <option value="10" selected>10 seconds</option>
          <option value="30">30 seconds</option>
          <option value="60">1 minute</option>
        </select>
        <button type="button" id="toggleRefresh">⏸️ Stop</button>
      </div>
      <div class="log-filter">
        <label>Filter:</label>
        <input type="text" id="logSearchInput" placeholder="Search logs...">
        <button type="button" id="clearFilter">✕</button>
      </div>
      <button type="button" id="refreshLogsBtn">🔄 Refresh Now</button>
      <button type="button" id="clearLogsBtn" class="danger">🗑️ Clear Logs</button>
      <button type="button" id="downloadLogsBtn" class="secondary">📥 Download</button>
    </div>
    <div class="log-options">
      <div class="log-option">
        <input type="checkbox" id="showTimestamps" checked>
        <label for="showTimestamps">Show timestamps</label>
      </div>
      <div class="log-option">
        <input type="checkbox" id="autoScroll" checked>
        <label for="autoScroll">Auto-scroll to bottom</label>
      </div>
      <div class="log-option">
        <input type="checkbox" id="reverseOrder">
        <label for="reverseOrder">Newest first</label>
      </div>
      <div class="log-option">
        <input type="checkbox" id="pauseOnScroll" checked>
        <label for="pauseOnScroll">Pause when scrolling up</label>
      </div>
    </div>
    <div class="log-container" id="logContainer">
      <div class="log-empty">Loading logs...</div>
      <div class="scroll-indicator" id="scrollToBottom" title="Scroll to bottom">⬇</div>
    </div>
  </div>
  <script>
    function apiCall(url, opts={}) {
      return fetch(url, opts).then(r => {
        if (!r.ok) return r.text().then(t=>{ showError(t); throw new Error(t); });
        return r;
      });
    }
    function showError(msg) {
      document.getElementById('error').textContent = msg;
      setTimeout(()=>{ document.getElementById('error').textContent = ''; }, 4000);
    }
    // Status polling
    function pollStatus() {
      apiCall('/api/status').then(r=>r.json()).then(st=>{
        document.getElementById('tankFull').textContent = st.tank_full ? 'Yes' : 'No';
        document.getElementById('filling').textContent = st.filling ? 'Yes' : 'No';
        document.getElementById('humidifierPump').textContent = st.humidifier_pump ? 'Yes' : 'No';
        document.getElementById('wateringPump').textContent = st.watering_pump ? 'Yes' : 'No';
        document.getElementById('wateringToday').textContent = st.watering_today ? 'Yes' : 'No';
        document.getElementById('ntp').textContent = st.ntp_synced ? 'Yes' : 'No';
        document.getElementById('time').textContent = st.time;
        
        // Update watering duration inputs only if they don't have focus (user isn't editing them)
        if (st.watering_duration_ms !== undefined) {
          const wateringMsInput = document.getElementById('wateringMs');
          const wateringDurationInput = document.getElementById('wateringDuration');
          
          if (document.activeElement !== wateringMsInput) {
            wateringMsInput.value = st.watering_duration_ms;
          }
          if (document.activeElement !== wateringDurationInput) {
            wateringDurationInput.value = st.watering_duration_ms;
          }
        }
      }).catch(()=>{});
    }
    setInterval(pollStatus, 2000); pollStatus();
    
    // Weekly dosing table
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    function loadWeeklyDosing() {
      Promise.all([
        fetch('/api/weekly_dosing').then(r=>r.json()),
        fetch('/api/weekly_watering_enabled').then(r=>r.json())
      ]).then(([weekly, enabled]) => {
        const tbody = document.querySelector('#weeklyDosingTable tbody');
        tbody.innerHTML = '';
        weekly.forEach((dayDosing, day) => {
          const row = tbody.insertRow();
          
          // Day name cell
          const dayCell = row.insertCell();
          dayCell.textContent = dayNames[day];
          
          // Enable/disable checkbox cell
          const enableCell = row.insertCell();
          enableCell.innerHTML = `<input type="checkbox" id="day${day}_enabled" ${enabled[day] ? 'checked' : ''}>`;
          
          // Fertilizer dosing cells
          dayDosing.forEach((ml, fert) => {
            const cell = row.insertCell();
            cell.innerHTML = `<input type="number" step="0.1" class="dosing-input" id="day${day}_fert${fert}" value="${ml}">`;
          });
        });
      }).catch(()=>{});
    }
    loadWeeklyDosing();
    
    // Save weekly dosing
    document.getElementById('weeklyDosingForm').onsubmit = function(e){
      e.preventDefault();
      
      // Save dosing amounts
      const dosingData = new URLSearchParams();
      for(let day = 0; day < 7; day++) {
        for(let fert = 0; fert < 5; fert++) {
          const input = document.getElementById(`day${day}_fert${fert}`);
          if(input) dosingData.append(`day${day}_fert${fert}`, input.value);
        }
      }
      
      // Save enabled/disabled settings
      const enabledData = new URLSearchParams();
      for(let day = 0; day < 7; day++) {
        const checkbox = document.getElementById(`day${day}_enabled`);
        if(checkbox) enabledData.append(`day${day}_enabled`, checkbox.checked ? 'true' : 'false');
      }
      
      // Send both requests
      Promise.all([
        apiCall('/api/weekly_dosing', {method:'POST', body:dosingData}),
        apiCall('/api/weekly_watering_enabled', {method:'POST', body:enabledData})
      ]).catch(()=>{});
    };
    
    // Load schedule
    fetch('/api/schedule').then(r=>r.json()).then(sch=>{
      document.getElementById('hour').value = sch.hour;
      document.getElementById('minute').value = sch.minute;
    });
    // Save schedule
    document.getElementById('scheduleForm').onsubmit = function(e){
      e.preventDefault();
      const data = new URLSearchParams();
      data.append('hour', document.getElementById('hour').value);
      data.append('minute', document.getElementById('minute').value);
      apiCall('/api/schedule', {method:'POST', body:data}).catch(()=>{});
    };
    // Main tank fill/stop
    document.getElementById('fillMainBtn').onclick = function(){
      apiCall('/api/fill_main_tank', {method:'POST'}).catch(()=>{});
    };
    document.getElementById('stopMainBtn').onclick = function(){
      apiCall('/api/stop_main_tank', {method:'POST'}).catch(()=>{});
    };
    // Watering sequence
    document.getElementById('startWateringBtn').onclick = function(){
      apiCall('/api/start_watering', {method:'POST'})
        .catch(()=>{});
    };
    // Humidifier pump run/stop
    document.getElementById('humidifierPumpForm').onsubmit = function(e){
      e.preventDefault();
      const ms = document.getElementById('humidifierMs').value;
      const data = new URLSearchParams();
      data.append('ms', ms);
      apiCall('/api/run_humidifier_pump', {method:'POST', body:data}).catch(()=>{});
    };
    document.getElementById('stopHumidifierBtn').onclick = function(){
      apiCall('/api/stop_humidifier_pump', {method:'POST'}).catch(()=>{});
    };
    
    // Watering pump run/stop
    document.getElementById('wateringPumpForm').onsubmit = function(e){
      e.preventDefault();
      const ms = document.getElementById('wateringMs').value;
      const data = new URLSearchParams();
      data.append('ms', ms);
      apiCall('/api/run_watering_pump', {method:'POST', body:data}).catch(()=>{});
    };
    document.getElementById('stopWateringBtn').onclick = function(){
      apiCall('/api/stop_watering_pump', {method:'POST'}).catch(()=>{});
    };
    // Load fertilizer motor speed
    fetch('/api/fertilizer_motor_speed').then(r=>r.json()).then(data=>{
      document.getElementById('fertSpeed').value = data.fertilizer_motor_speed;
    });
    // Save system settings (fertilizer motor speed and watering duration)
    document.getElementById('fertSpeedForm').onsubmit = function(e){
      e.preventDefault();
      
      // Save fertilizer motor speed
      const fertData = new URLSearchParams();
      fertData.append('fertilizer_motor_speed', document.getElementById('fertSpeed').value);
      apiCall('/api/fertilizer_motor_speed', {method:'POST', body:fertData});
      
      // Save watering duration
      const waterData = new URLSearchParams();
      waterData.append('watering_duration_ms', document.getElementById('wateringDuration').value);
      apiCall('/api/watering_duration', {method:'POST', body:waterData}).then(()=>{
        // Update the manual run form with the new default value
        document.getElementById('wateringMs').value = document.getElementById('wateringDuration').value;
      });
    };
    
    // Load watering duration
    fetch('/api/watering_duration').then(r=>r.json()).then(data=>{
      document.getElementById('wateringDuration').value = data.watering_duration_ms;
      document.getElementById('wateringMs').value = data.watering_duration_ms;
    });
    // Load calibration
    apiCall('/api/calibration').then(r=>r.json()).then(cal=>{
      const ci = document.getElementById('calInputs');
      const fertilizerNames = ['Bio-Grow', 'Bio-Bloom', 'Top-Max', 'CalMag', 'PhDown'];
      ci.innerHTML = '';
      cal.forEach((c, i) => {
        ci.innerHTML += `
          <div class="cal-grid">
            <div class="cal-label">${fertilizerNames[i]}</div>
            <div class="cal-input-group">
              <input type="number" step="0.01" id="cal${i}" value="${c}">
              <span class="cal-unit">ml/sec</span>
            </div>
          </div>
        `;
      });
    });
    // Save calibration
    document.getElementById('calForm').onsubmit = function(e){
      e.preventDefault();
      const data = new URLSearchParams();
      for(let i=0;i<5;i++) data.append('cal'+i, document.getElementById('cal'+i).value);
      apiCall('/api/calibration', {method:'POST', body: data}).catch(()=>{});
    };
    
    // Debug pump controls
    document.getElementById('debugBioGrowOn').onclick = function(){
      const speed = document.getElementById('fertSpeed').value;
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '0', action: 'on', speed: speed})}).catch(()=>{});
    };
    document.getElementById('debugBioGrowOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '0', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('debugBioBloomOn').onclick = function(){
      const speed = document.getElementById('fertSpeed').value;
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '1', action: 'on', speed: speed})}).catch(()=>{});
    };
    document.getElementById('debugBioBloomOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '1', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('debugTopMaxOn').onclick = function(){
      const speed = document.getElementById('fertSpeed').value;
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '2', action: 'on', speed: speed})}).catch(()=>{});
    };
    document.getElementById('debugTopMaxOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '2', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('debugCalMagOn').onclick = function(){
      const speed = document.getElementById('fertSpeed').value;
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '3', action: 'on', speed: speed})}).catch(()=>{});
    };
    document.getElementById('debugCalMagOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '3', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('debugPhDownOn').onclick = function(){
      const speed = document.getElementById('fertSpeed').value;
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '4', action: 'on', speed: speed})}).catch(()=>{});
    };
    document.getElementById('debugPhDownOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '4', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('debugMainTankOn').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '5', action: 'on'})}).catch(()=>{});
    };
    document.getElementById('debugMainTankOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '5', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('debugHumidifierPumpOn').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '6', action: 'on'})}).catch(()=>{});
    };
    document.getElementById('debugHumidifierPumpOff').onclick = function(){
      apiCall('/api/debug_pump', {method:'POST', body: new URLSearchParams({pump: '6', action: 'off'})}).catch(()=>{});
    };
    document.getElementById('stopAllPumps').onclick = function(){
      apiCall('/api/stop_all_pumps', {method:'POST'}).catch(()=>{});
    };

    // Logs functionality
    let logRefreshInterval = null;
    let isRefreshing = true;
    let userScrolledUp = false;
    let lastScrollTop = 0;
    let logEntries = [];
    let filterText = '';
    
    function updateConnectionStatus(connected, loading = false) {
      const statusDot = document.getElementById('connectionStatus');
      const statusText = document.getElementById('connectionText');
      
      statusDot.classList.remove('disconnected', 'loading');
      
      if (loading) {
        statusDot.classList.add('loading');
        statusText.textContent = 'Loading...';
      } else if (connected) {
        statusText.textContent = 'Connected';
      } else {
        statusDot.classList.add('disconnected');
        statusText.textContent = 'Disconnected';
      }
    }
    
    function formatLogEntry(logLine, index) {
      // Parse log format: [2025-09-15 14:32:15] Message
      const match = logLine.match(/^(\[.+?\])\s*(.*)$/);
      const showTimestamps = document.getElementById('showTimestamps').checked;
      const isFiltered = filterText && !logLine.toLowerCase().includes(filterText.toLowerCase());
      const isHighlighted = filterText && logLine.toLowerCase().includes(filterText.toLowerCase()) && filterText.length > 0;
      
      let html = '<div class="log-entry' + (isFiltered ? ' filtered' : '') + (isHighlighted ? ' highlight' : '') + '">';
      
      if (match) {
        html += '<span class="log-timestamp' + (showTimestamps ? '' : ' hidden') + '">' + match[1] + '</span> ';
        html += '<span class="log-message">' + escapeHtml(match[2]) + '</span>';
      } else {
        html += '<span class="log-message">' + escapeHtml(logLine) + '</span>';
      }
      
      html += '</div>';
      return html;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function applyLogOptions() {
      const container = document.getElementById('logContainer');
      const reverseOrder = document.getElementById('reverseOrder').checked;
      const showTimestamps = document.getElementById('showTimestamps').checked;
      
      // Re-render all entries with current options
      let displayEntries = [...logEntries];
      if (reverseOrder) {
        displayEntries.reverse();
      }
      
      container.innerHTML = displayEntries.map(formatLogEntry).join('');
      
      // Add scroll indicator
      container.innerHTML += '<div class="scroll-indicator" id="scrollToBottom" title="Scroll to bottom">⬇</div>';
      
      // Re-attach scroll to bottom handler
      document.getElementById('scrollToBottom').onclick = function() {
        container.scrollTop = container.scrollHeight;
        updateScrollIndicator();
      };
      
      // Apply auto-scroll if enabled and user hasn't scrolled up
      if (document.getElementById('autoScroll').checked && !userScrolledUp) {
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 50);
      }
      
      updateScrollIndicator();
    }
    
    function updateScrollIndicator() {
      const container = document.getElementById('logContainer');
      const scrollIndicator = document.getElementById('scrollToBottom');
      const isAtBottom = container.scrollTop >= container.scrollHeight - container.clientHeight - 10;
      
      if (scrollIndicator) {
        scrollIndicator.classList.toggle('visible', !isAtBottom && logEntries.length > 0);
      }
    }
    
    function loadLogs() {
      updateConnectionStatus(true, true);
      
      return apiCall('/api/logs')
        .then(r => r.json())
        .then(logs => {
          const container = document.getElementById('logContainer');
          const logCount = document.getElementById('logCount');
          const lastUpdate = document.getElementById('lastUpdate');
          
          logEntries = logs;
          
          if (logs.length === 0) {
            container.innerHTML = '<div class="log-empty">No logs available</div>';
            logCount.textContent = '0';
          } else {
            logCount.textContent = logs.length;
            applyLogOptions();
          }
          
          // Update last refresh time
          const now = new Date();
          lastUpdate.textContent = '(Updated: ' + now.toLocaleTimeString() + ')';
          
          updateConnectionStatus(true);
        })
        .catch(() => {
          updateConnectionStatus(false);
          document.getElementById('logContainer').innerHTML = '<div class="log-empty">Failed to load logs</div>';
        });
    }
    
    function startAutoRefresh() {
      const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
      stopAutoRefresh();
      
      if (interval > 0) {
        logRefreshInterval = setInterval(() => {
          const pauseOnScroll = document.getElementById('pauseOnScroll').checked;
          if (!pauseOnScroll || !userScrolledUp) {
            loadLogs();
          }
        }, interval);
        isRefreshing = true;
        document.getElementById('toggleRefresh').textContent = '⏸️ Stop';
      } else {
        isRefreshing = false;
        document.getElementById('toggleRefresh').textContent = '▶️ Start';
      }
      
      // Save preference
      localStorage.setItem('logRefreshInterval', document.getElementById('refreshInterval').value);
    }
    
    function stopAutoRefresh() {
      if (logRefreshInterval) {
        clearInterval(logRefreshInterval);
        logRefreshInterval = null;
      }
    }
    
    function applyFilter() {
      filterText = document.getElementById('logSearchInput').value.trim();
      applyLogOptions();
      
      // Update log count for filtered results
      const visibleCount = document.querySelectorAll('.log-entry:not(.filtered)').length;
      const totalCount = logEntries.length;
      
      if (filterText) {
        document.getElementById('logCount').textContent = visibleCount + ' / ' + totalCount;
      } else {
        document.getElementById('logCount').textContent = totalCount.toString();
      }
    }
    
    // Load saved preferences
    const savedInterval = localStorage.getItem('logRefreshInterval');
    if (savedInterval) {
      document.getElementById('refreshInterval').value = savedInterval;
    }
    
    const savedOptions = {
      showTimestamps: localStorage.getItem('showTimestamps') !== 'false',
      autoScroll: localStorage.getItem('autoScroll') !== 'false',
      reverseOrder: localStorage.getItem('reverseOrder') === 'true',
      pauseOnScroll: localStorage.getItem('pauseOnScroll') !== 'false'
    };
    
    Object.keys(savedOptions).forEach(option => {
      const element = document.getElementById(option);
      if (element) element.checked = savedOptions[option];
    });
    
    // Event handlers
    document.getElementById('refreshInterval').onchange = startAutoRefresh;
    
    document.getElementById('toggleRefresh').onclick = function() {
      if (isRefreshing) {
        stopAutoRefresh();
        isRefreshing = false;
        this.textContent = '▶️ Start';
      } else {
        startAutoRefresh();
      }
    };
    
    document.getElementById('refreshLogsBtn').onclick = function() {
      loadLogs();
      userScrolledUp = false; // Reset scroll state on manual refresh
    };
    
    document.getElementById('clearLogsBtn').onclick = function() {
      if (confirm('Are you sure you want to clear all logs? This cannot be undone.')) {
        apiCall('/api/logs', {method: 'DELETE'})
          .then(() => {
            loadLogs();
          })
          .catch(() => {});
      }
    };
    
    document.getElementById('downloadLogsBtn').onclick = function() {
      window.open('/api/logs/download', '_blank');
    };
    
    // Log search functionality
    let searchTimeout;
    document.getElementById('logSearchInput').oninput = function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilter, 300); // Debounce search
    };
    
    document.getElementById('clearFilter').onclick = function() {
      document.getElementById('logSearchInput').value = '';
      applyFilter();
    };
    
    // Log option checkboxes
    ['showTimestamps', 'autoScroll', 'reverseOrder', 'pauseOnScroll'].forEach(option => {
      document.getElementById(option).onchange = function() {
        localStorage.setItem(option, this.checked);
        applyLogOptions();
      };
    });
    
    // Scroll detection
    document.getElementById('logContainer').onscroll = function() {
      const container = this;
      const isAtBottom = container.scrollTop >= container.scrollHeight - container.clientHeight - 10;
      
      // Detect if user scrolled up
      if (container.scrollTop < lastScrollTop && !isAtBottom) {
        userScrolledUp = true;
      } else if (isAtBottom) {
        userScrolledUp = false;
      }
      
      lastScrollTop = container.scrollTop;
      updateScrollIndicator();
    };
    
    // Keyboard shortcuts
    document.onkeydown = function(e) {
      // Only trigger if not in an input field
      if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        if (e.key === 'r' || e.key === 'R') {
          e.preventDefault();
          document.getElementById('refreshLogsBtn').click();
        } else if (e.key === 'c' || e.key === 'C') {
          e.preventDefault();
          document.getElementById('clearLogsBtn').click();
        }
      }
    };
    
    // Initialize logs
    loadLogs();
    startAutoRefresh();
  </script>
</body>
</html>